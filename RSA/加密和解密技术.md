### 加密和解密技术和协议

#### 加密算法和协议

>对称加密：数据加密（保密性），加密方与解密方使用同一个口令，加密算法：DES（56bits）, 3DES, AES(128bits), IDEA, RC6, CAST5, Serpent

>公钥加密：身份认证、密钥交换、数据加密（不常用，比堆成加密要慢3个数量级），加密算法：RSA,EIGmal，DSA

>密钥交换：(IKE: Internet Key Exchange)：DH算法

>单向加密：抽取数据特征码、指纹（MD5[128bits], CRC-32, SHA1[160bits], SHA512[512bits],...），雪崩效应(微小改变即对结果影响巨大)，定长输入


#### A -> B进行安全通信握手与密钥交换

>- 1.A用单向加密提取要发送资料数据的指纹信息，而后用A的私钥对指纹信息进行加密，此步骤为数字签名，为了身份认证

>- 2.A用对称加密算法对数字签名结果与数据的指纹信息进行加密，因对称加密算法需要密钥，即A需产生一次性会话加密密钥（也称为临时密钥）并结合对称加密算法进行加密

>- 3.A并用B的公钥加密一次性会话加密密钥，附加一并发送给B

>- 4.B接收到A发送过来的数据报文，先用B的私钥去解密数据报文中的一次性会话密钥，接着用解密后的密钥数据作为解密密钥采用对称加密反向解密出报文信息中的真正数据

>- 5.B用A的公钥解密报文信息中的特征码，验证身份来源的确来源于A，并用同样的单向加密算法计算该报文信息中的明文的特征码，并对比两者的特征码，验证数据完整性

#### SSL

>SSL会话主要三步

```
1.客户端向服务器端索要并验证证书
2.双方协商生成“会话密钥”，以上两步统称为安全通信握手
3.双方采用“会话密码”进行加密通信

```
>SSL协议实现

Http依赖于 SSL(安全套接字层)或TLS(传输层安全)协议即为Https，而任何一种协议都必须要有实现，而SSL的实现是 OpenSSL

>OpenSSL是一组套件，开源程序

```
libcrypto: 通用功能的加密库
libssl: 用于实现TLS/SSL的功能
openssl: 多功能命令行工具，生成密钥、创建数字证书、手动加密解密数据
```

#### [SSL Handshake Protocol 会话的四个阶段](http://www.cheat-sheets.org/saved-copy/Ssl_handshake_with_two_way_authentication_with_certificates-1.pdf)

> 第一阶段：客户端向服务器端发加密通信请求 - ClientHello

```
1. 客户端向服务器端发送支持的协议版本，如tls 1.2
2. 客户端生成一个随机数，稍后用户生成“会话密钥”
3. 客户端向服务器发送支持的加密算法，如 AES、RSA、DSA等
4. 客户端向服务器发送支持的压缩算法


```
>第二阶段：服务器端收到进行回应 -  ServerHello

```
1. 服务器端回应确认使用的加密通信协议版本，如tls 1.2，若不符合即关闭加密通信
2. 服务器端生成一个随机数，稍后用于生成“会话密钥”
3. 服务器端回应确认使用的加密算法
4. 服务器端发送服务器证书
5. 如果服务器端也要验证客户端证书，此时服务器端需要向客户端索要客户端证书

```
>第三阶段： 客户端

```
1. 验证服务器证书，包括（发证机构、证书完整性、持有者的个人合法身份信息、主机名CA的信息、证书有效期限、吊销列表等）
2. 验证证书确认无误后取出其公钥，并发送一下信息给服务器端：
	a. 一个随机数，用于服务器上的公钥加密
	b. 编码变更通知，随后信息将根据双方商定后的加密方法和密钥通信
	c. 客户端握手结束通知

```

>第四阶段：服务器

```
1. 收到客户端发来的第三阶段的随机数 pre-master-key 后，计算生成本次会话所用到的“会话密钥”
2. 向客户端发送如下信息：
	a. 编码变更通知，随后信息将根据双方商定后的加密方法和密钥通信
	b. 服务器端握手结束通知
由于ssl通信的证书是静态的，因此有必要引入随机数来确保通信的会话密钥的随机安全，不具有可预测性

```

#### 公钥基础设施 PKI

> PKI：Public Key Infrastucture ，CA只是其中一部分，提供证书服务

> PKI 的基础组件

```
签证机构： CA
注册机构： RA
证书吊销列表： CRL
证书存储库


```

#### 数字证书

>证书格式：x.509、pkcs

```
.cer后缀的证书文件有两种编码-->DER二进制编码或者BASE64编码(也就是.pem)
.key格式：私有的密钥
.crt格式：证书文件，certificate的缩写，是2进制形式存放的，不含私钥
.csr格式：证书签名请求（证书请求文件），含有公钥信息，certificate signing request的缩写
.crl格式：证书吊销列表，Certificate Revocation List的缩写
.pem格式：用于导出，导入证书时候的证书的格式，有证书开头，结尾的固定格式，与crt/cer的区别是它以Ascii来表示

```

>常用证书协议

```
x509v3: IETF的证书标准
x.500: 目录的标准
SCEP:  简单证书申请协议，用http来进行申请，数据有PKCS#7封装，数据其实格式也是PKCS#10的
PKCS#7:  也简写为.p7r，是CA对证书请求的回复，只用于导入，封装数据的标准，可以放置证书和一些请求信息
PKCS#10:  也简写为.p10，证书请求，用于离线证书申请的证书申请的数据格式，注意数据包是使用PKCS#7封装这个数据
PKCS#12:  公钥加密标准，用于一个单一文件中交换公共和私有对象，就是公钥，私钥和证书，这些信息进行打包，加密放在存储目录中，CISCO放在NVRAM中，用户可以导出，以防证书服务器挂掉可以进行相应恢复，思科是.p12,微软是.pfx

```

其中`x.509v3` :定义了证书的结构以及认证协议标准

```
版本号
序列号
发行者名称
有效期限
主体公钥
发行者的唯一标识
主体的唯一标识
扩展
CA的数字签名

```




		谁给CA发证：自签署证书
